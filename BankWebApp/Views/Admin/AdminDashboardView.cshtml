@model BankWebApp.Models.AdminDashboardViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Admin Dashboard</h1>
    <button type="button" class="btn btn-outline-danger" onclick="performLogout()">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</div>

<p>This page calls the BankWebService API and lists user profiles, accounts, and transactions.</p>

@if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
{
    <div class="alert alert-danger">@err</div>
}
@if (TempData["Message"] is string msg && !string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-success">@msg</div>
}

@if (Model.Admin is not null)
{
    <div class="card mb-4">
        <div class="card-header">Admin</div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-3"><strong>Username:</strong> @Model.Admin.Username</div>
                <div class="col-md-3"><strong>Email:</strong> @Model.Admin.Email</div>
                <div class="col-md-3"><strong>Phone:</strong> @Model.Admin.Phone</div>
                <div class="col-md-3"><strong>Address:</strong> @Model.Admin.Address</div>
            </div>
        </div>
    </div>
}

<div class="card mb-4">
    <div class="card-header">Create Account</div>
    <div class="card-body">
        <div class="row gy-2 gx-2 align-items-end">
            <div class="col-md-2">
                <label class="form-label">Username</label>
                <input id="username" class="form-control" required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Account Name</label>
                <input id="accountName" class="form-control" required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Email</label>
                <input id="email" class="form-control" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Starting Balance</label>
                <input id="balance" type="number" step="0.01" class="form-control" value="0" />
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary btn-create-account">Create</button>
            </div>
        </div>
    </div>
</div>

<h2 id="usersHeader" style="cursor:pointer;">Users</h2>
<div id="usersSection" class="table-responsive">
    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Search by Username</label>
            <input type="text" id="searchUsername" class="form-control" placeholder="Enter username" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Search by Email</label>
            <input type="text" id="searchEmail" class="form-control" placeholder="Enter email" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Search by Phone</label>
            <input type="text" id="searchPhone" class="form-control" placeholder="Enter phone number" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-primary me-2" onclick="searchUsersLocal()">Search</button>
            <button type="button" class="btn btn-secondary" onclick="clearUserSearchLocal()">Clear</button>
        </div>
    </div>
    <table class="table table-striped" id="usersTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Address</th>
                <th>Phone</th>
                <th style="width: 160px;">Actions</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var u in Model.Users)
        {
            <tr>
                <td>@u.Username</td>
                <td>@u.Email</td>
                <td>@u.Address</td>
                <td>@u.Phone</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-warning btn-change-password" data-username="@u.Username">
                        Change Password
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<!-- Change Password Modal (single reusable modal) -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="changePasswordForm">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Change password for <span id="cp-username-display"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="Username" id="cp-username" />
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input name="NewPassword" type="password" class="form-control" required maxlength="30" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitPasswordChange()">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<h2 id="accountsHeader" style="cursor:pointer;">Accounts</h2>
<div id="accountsSection" class="table-responsive">
    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Search by Account Number</label>
            <input type="number" id="searchAccountNumber" class="form-control" placeholder="Enter account number" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Search by Username</label>
            <input type="text" id="searchAccountUsername" class="form-control" placeholder="Enter username" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Search by Email</label>
            <input type="text" id="searchAccountEmail" class="form-control" placeholder="Enter email" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-primary me-2" onclick="searchAccountsLocal()">Search</button>
            <button type="button" class="btn btn-secondary" onclick="clearAccountSearchLocal()">Clear</button>
        </div>
    </div>
    <table class="table table-striped" id="accountsTable">
        <thead>
            <tr>
                <th>Account #</th>
                <th>Username</th>
                <th>Email</th>
                <th class="text-end">Balance</th>
                <th style="width:200px"></th>
            </tr>
        </thead>
        <tbody>
        @foreach (var a in Model.Accounts.OrderBy(x => x.AccountNumber))
        {
            <tr>
                <td>@a.AccountNumber</td>
                <td>@a.Username</td>
                <td>@a.Email</td>
                <td class="text-end">@a.Balance</td>
                <td>
                    <div class="d-inline-flex align-items-center">
                        <input type="number" id="balance-@a.AccountNumber" step="0.01" class="form-control form-control-sm w-auto me-1" value="@a.Balance" />
                        <button type="button" class="btn btn-sm btn-outline-primary me-1 btn-update-account" 
                                data-account-number="@a.AccountNumber" 
                                data-username="@a.Username" 
                                data-email="@a.Email">Update</button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2 btn-delete-account" 
                            data-account-number="@a.AccountNumber">Delete</button>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<h2 id="transactionsHeader" style="cursor:pointer;">Transactions</h2>
<div id="transactionsSection" class="table-responsive">
    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Search by Transaction ID</label>
            <input type="number" id="searchTransactionId" class="form-control" placeholder="Enter transaction ID" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Search by Account Number</label>
            <input type="number" id="searchTransactionAccount" class="form-control" placeholder="Enter account number" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Filter by Type</label>
            <select id="searchTransactionType" class="form-select">
                <option value="">All Types</option>
                <option value="Deposit">Deposit</option>
                <option value="Withdraw">Withdraw</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-primary me-2" onclick="searchTransactionsLocal()">Search</button>
            <button type="button" class="btn btn-secondary" onclick="clearTransactionSearchLocal()">Clear</button>
        </div>
    </div>
    <table class="table table-bordered" id="transactionsTable">
        <thead>
            <tr>
                <th>Id</th>
                <th>Account #</th>
                <th>Type</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var t in Model.Transactions.OrderByDescending(x => x.TransactionId))
        {
            <tr>
                <td>@t.TransactionId</td>
                <td>@t.AccountNumber</td>
                <td>@t.Type</td>
                <td>@t.Amount</td>
            </tr>
        }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        // Initialize admin dashboard when the page loads
        $(function () {
            // Guard optional initializer so the rest of this script still runs
            if (typeof initializeAdminDashboard === 'function') {
                try { initializeAdminDashboard(); } catch (e) { /* ignore */ }
            }

            // Populate username when modal is about to be shown (Bootstrap data API)
            const modalEl = document.getElementById('changePasswordModal');
            if (modalEl) {
                modalEl.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget; // Button that triggered the modal
                    const username = button?.getAttribute('data-username') || '';
                    $('#cp-username').val(username);
                    $('#cp-username-display').text(username);
                });
            }

            // Fallback: explicitly open the modal and set username if data API didn?t fire
            $(document).on('click', '.btn-change-password', function () {
                const username = $(this).data('username') || '';
                $('#cp-username').val(username);
                $('#cp-username-display').text(username);
                const modalInstance = new bootstrap.Modal(document.getElementById('changePasswordModal'));
                modalInstance.show();
            });
        });

        function submitPasswordChange() {
            const form = $('#changePasswordForm');
            const url = '@Url.Action("ChangeUserPassword", "Admin")';

            // Submit form using AJAX
            $.ajax({
                type: 'POST',
                url: url,
                data: form.serialize(),
                success: function (response) {
                    // Handle success response
                    if (response.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                        modal.hide();

                        // Show success message
                        alert(response.message);
                    } else {
                        // Show error message
                        alert(response.message);
                    }
                },
                error: function () {
                    // Handle error
                    alert('An error occurred while changing the password. Please try again.');
                }
            });
        }
    </script>
}