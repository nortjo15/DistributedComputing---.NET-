@model BankWebApp.Models.AdminDashboardViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
}

<h1>Admin dashboard</h1>
<p>This page calls the BankWebService API and lists user profiles, accounts, and transactions.</p>

@if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
{
    <div class="alert alert-danger">@err</div>
}
@if (TempData["Message"] is string msg && !string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-success">@msg</div>
}

@if (Model.Admin is not null)
{
    <div class="card mb-4">
        <div class="card-header">Admin</div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-3"><strong>Username:</strong> @Model.Admin.Username</div>
                <div class="col-md-3"><strong>Email:</strong> @Model.Admin.Email</div>
                <div class="col-md-3"><strong>Phone:</strong> @Model.Admin.Phone</div>
                <div class="col-md-3"><strong>Address:</strong> @Model.Admin.Address</div>
            </div>
        </div>
    </div>
}

<div class="card mb-4">
    <div class="card-header">Create Account</div>
    <div class="card-body">
        <form asp-controller="Admin" asp-action="CreateAccount" method="post" class="row gy-2 gx-2 align-items-end">
            @Html.AntiForgeryToken()
            <div class="col-md-3">
                <label class="form-label">Username</label>
                <input name="Username" class="form-control" required />
            </div>
            <div class="col-md-4">
                <label class="form-label">Email</label>
                <input name="Email" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Starting Balance</label>
                <input name="Balance" type="number" step="0.01" class="form-control" value="0" />
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <h2>Users</h2>
    <table class="table table-striped" id="usersTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Address</th>
                <th>Phone</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var u in Model.Users)
        {
            <tr>
                <td>@u.Username</td>
                <td>@u.Email</td>
                <td>@u.Address</td>
                <td>@u.Phone</td>
            </tr>
        }
        </tbody>
    </table>
</div>

<div class="table-responsive">
    <h2>Accounts</h2>
    <table class="table table-striped" id="accountsTable">
        <thead>
            <tr>
                <th>Account #</th>
                <th>Username</th>
                <th>Email</th>
                <th class="text-end">Balance</th>
                <th style="width:200px"></th>
            </tr>
        </thead>
        <tbody>
        @foreach (var a in Model.Accounts.OrderBy(x => x.AccountNumber))
        {
            <tr>
                <td>@a.AccountNumber</td>
                <td>@a.Username</td>
                <td>@a.Email</td>
                <td class="text-end">@a.Balance</td>
                <td>
                    <form asp-controller="Admin" asp-action="UpdateAccount" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="AccountNumber" value="@a.AccountNumber" />
                        <input type="hidden" name="Username" value="@a.Username" />
                        <input type="hidden" name="Email" value="@a.Email" />
                        <input type="number" name="Balance" step="0.01" class="form-control form-control-sm d-inline w-auto" value="@a.Balance" />
                        <button type="submit" class="btn btn-sm btn-outline-primary ms-1">Update</button>
                    </form>
                    <form asp-controller="Admin" asp-action="DeleteAccount" method="post" class="d-inline ms-2" onsubmit="return confirm('Delete account @a.AccountNumber?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="accountNumber" value="@a.AccountNumber" />
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<div class="table-responsive">
    <h2>Transactions</h2>
    <select id="txTypeFilter" class="form-select form-select-sm w-auto mb-2">
        <option value="">All</option>
        <option value="Deposit">Deposit</option>
        <option value="Withdraw">Withdraw</option>
    </select>
    <table class="table table-bordered" id="transactionsTable">
        <thead>
            <tr>
                <th>Id</th>
                <th>Account #</th>
                <th>Type</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var t in Model.Transactions.OrderByDescending(x => x.TransactionId))
        {
            <tr>
                <td>@t.TransactionId</td>
                <td>@t.AccountNumber</td>
                <td>@t.Type</td>
                <td>@t.Amount</td>
            </tr>
        }
        </tbody>
    </table>
</div>

@section Scripts {
<script>
  $(function () {
    // Users
    $('#usersTable').DataTable({
      pageLength: 10,
      order: [],
      columns: [null, null, null, null]
    });

    // Accounts
    $('#accountsTable').DataTable({
      pageLength: 10,
      order: [[0, 'asc']],
      columnDefs: [
        { targets: 0, type: 'num' },
        { targets: 3, render: $.fn.dataTable.render.number(',', '.', 2) }
      ]
    });

    // Transactions
    const txTable = $('#transactionsTable').DataTable({
      pageLength: 25,
      order: [[0, 'desc']],
      columnDefs: [
        { targets: [0, 1], type: 'num' },
        { targets: 3, render: $.fn.dataTable.render.number(',', '.', 2) }
      ]
    });

    // Filter by Type (column index 2)
    $('#txTypeFilter').on('change', function () {
      txTable.column(2).search(this.value).draw();
    });
  });
</script>
}
